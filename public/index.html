<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magi</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; color: #333; line-height: 1.6; }
    .login-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 2000; }
    .login-box { background-color: white; padding: 3rem; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
    .login-title { font-size: 1.8rem; font-weight: 600; margin-bottom: 0.5rem; text-align: center; }
    .login-form { display: flex; flex-direction: column; gap: 1.2rem; }
    .form-label { font-weight: 500; margin-bottom: 0.5rem; color: #444; font-size: 0.9rem; }
    .form-input { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem; font-family: inherit; }
    .form-input:focus { outline: none; border-color: #667eea; background-color: #f9f9f9; }
    .login-btn { width: 100%; padding: 0.8rem; background-color: #667eea; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; margin-top: 0.5rem; }
    .login-btn:hover { background-color: #5568d3; }
    .main-app { display: none; }
    .main-app.logged-in { display: block; }
    .header { background-color: #fff; border-bottom: 1px solid #e0e0e0; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .header-left { display: flex; align-items: center; gap: 1rem; }
    .header-title { font-size: 1.2rem; font-weight: 600; letter-spacing: 0.5px; }
    .menu-toggle { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; color: #666; }
    .logout-btn { padding: 0.4rem 0.8rem; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #666; }
    .sidebar { position: fixed; left: 0; top: 0; width: 250px; height: 100vh; background-color: #f9f9f9; border-right: 1px solid #e0e0e0; transform: translateX(-250px); transition: transform 0.3s ease; z-index: 1000; overflow-y: auto; padding-top: 3rem; }
    .sidebar.active { transform: translateX(0); }
    .sidebar-menu { list-style: none; }
    .sidebar-menu button { display: block; width: 100%; padding: 1rem; background: none; border: none; text-align: left; cursor: pointer; font-size: 0.95rem; color: #555; transition: all 0.2s; }
    .sidebar-menu button:hover { background-color: #efefef; color: #333; padding-left: 1.5rem; }
    .sidebar-menu button.active { background-color: #e8e8e8; color: #000; font-weight: 600; padding-left: 1.5rem; }
    .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.3); display: none; z-index: 999; }
    .overlay.active { display: block; }
    .main-content { max-width: 800px; margin: 0 auto; padding: 2rem 1rem; }
    .container { display: none; }
    .container.active { display: block; }
    .form-container { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem; }
    .form-group { margin-bottom: 1.5rem; }
    textarea { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 0.95rem; resize: vertical; min-height: 120px; }
    .form-options { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
    .form-select { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 0.95rem; }
    .btn-submit { width: 100%; padding: 0.8rem; background-color: #333; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; }
    .btn-submit:hover { background-color: #555; }
    .result-container { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem; }
    .result-header { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #e0e0e0; }
    .final-answer { background-color: #f9f9f9; padding: 1.5rem; border-radius: 4px; margin-bottom: 2rem; border-left: 4px solid #333; }
    .final-label { font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; }
    .final-text { color: #333; line-height: 1.8; }
    .metrics { margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0; }
    .metric-item { text-align: center; }
    .metric-value { font-size: 1.2rem; font-weight: 600; color: #333; }
    .metric-label { font-size: 0.75rem; color: #999; margin-top: 0.3rem; text-transform: uppercase; }
    .status-message { padding: 1rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.9rem; }
    .status-loading { background-color: #e3f2fd; color: #1565c0; border-left: 4px solid #1565c0; }
    .status-error { background-color: #ffebee; color: #c62828; border-left: 4px solid #c62828; }
    .pattern-options { display: flex; flex-direction: column; gap: 1rem; }
    .pattern-option { display: flex; align-items: flex-start; gap: 1rem; }
    .pattern-option input[type="radio"] { margin-top: 0.4rem; cursor: pointer; }
    .pattern-label { flex: 1; cursor: pointer; }
    .pattern-name { font-weight: 600; color: #333; margin-bottom: 0.3rem; }
    .pattern-desc { font-size: 0.85rem; color: #666; }
    .upload-container { display: none; margin-top: 1.5rem; padding: 1.5rem; background-color: #f9f9f9; border-radius: 4px; border: 2px dashed #ddd; }
    .upload-container.active { display: block; }
    .upload-label { display: block; font-weight: 600; margin-bottom: 1rem; color: #333; font-size: 0.95rem; }
    .upload-input { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>

  <div class="login-container" id="loginContainer">
    <div class="login-box">
      <div class="login-title">Magi</div>
      <form class="login-form" id="loginForm">
        <div class="form-group">
          <label class="form-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
          <input type="text" id="userId" class="form-input" placeholder="admin" required>
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="userPassword" class="form-input" placeholder="magi2024" required>
        </div>
        <button type="submit" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </form>
    </div>
  </div>

  <div class="main-app" id="mainApp">
    <div class="header">
      <div class="header-left">
        <button class="menu-toggle" id="menuToggle">â‰¡</button>
        <div class="header-title">Magi</div>
      </div>
      <button class="logout-btn" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div class="overlay" id="overlay"></div>
    <aside class="sidebar" id="sidebar">
      <ul class="sidebar-menu">
        <li><button class="sidebar-btn active" data-tab="question">è³ªå•ã‚’é€ä¿¡</button></li>
        <li><button class="sidebar-btn" data-tab="stock">æ ªä¾¡èª¿æŸ»</button></li>
        <li><button class="sidebar-btn" data-tab="history">å±¥æ­´</button></li>
        <li><button class="sidebar-btn" data-tab="settings">âš™ è¨­å®š</button></li>
      </ul>
    </aside>

    <div class="main-content">
      
      <div id="question" class="container active">
        <div class="form-container">
          <div class="form-group">
            <label class="form-label">è³ªå•å†…å®¹</label>
            <textarea id="prompt" placeholder="ã“ã“ã«è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
          </div>
          <div class="form-options">
            <div class="form-group">
              <label class="form-label">å‹•ä½œãƒ¢ãƒ¼ãƒ‰</label>
              <select id="mode" class="form-select">
                <option value="consensus">Consensusï¼ˆåˆè­°ï¼‰</option>
                <option value="integration">Integrationï¼ˆçµ±åˆï¼‰</option>
                <option value="synthesis">Synthesisï¼ˆå‰µç™ºï¼‰</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">æ¸©åº¦è¨­å®š</label>
              <select id="temperature" class="form-select">
                <option value="0.2">ä¿å®ˆçš„ï¼ˆ0.2ï¼‰</option>
                <option value="0.5">ãƒãƒ©ãƒ³ã‚¹ï¼ˆ0.5ï¼‰</option>
                <option value="0.8">å‰µé€ çš„ï¼ˆ0.8ï¼‰</option>
              </select>
            </div>
          </div>
          <button id="submitBtn" class="btn-submit">é€ä¿¡ï¼ˆ3AIåˆè­°ï¼‰</button>
        </div>
        <div id="resultArea"></div>
      </div>

      <div id="stock" class="container">
        <div class="form-container">
          <div class="result-header">æ ªä¾¡èª¿æŸ»ãƒ»3AIåˆ†æ</div>
          <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
            <input type="text" id="ticker" placeholder="ãƒ†ã‚£ãƒƒã‚«ãƒ¼ä¾‹ï¼šAAPL" maxlength="10" style="flex: 1; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px;">
            <button id="searchStockBtn" class="btn-submit" style="width: auto; padding: 0.8rem 1.5rem;">æ¤œç´¢</button>
          </div>

          <div style="margin-bottom: 2rem; padding: 1.5rem; background-color: #f9f9f9; border-radius: 4px; border-left: 4px solid #333;">
            <div style="font-weight: 600; margin-bottom: 1rem; font-size: 0.95rem;">åˆ†æãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ</div>
            
            <div class="pattern-options">
              <label class="pattern-option">
                <input type="radio" name="pattern" value="simple">
                <div class="pattern-label">
                  <div class="pattern-name">A. ã‚·ãƒ³ãƒ—ãƒ«æ¤œç´¢</div>
                  <div class="pattern-desc">ticker â†’ è²¡å‹™ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</div>
                </div>
              </label>

              <label class="pattern-option">
                <input type="radio" name="pattern" value="analysis" checked>
                <div class="pattern-label">
                  <div class="pattern-name">B. 3AIåˆ†æä»˜ã</div>
                  <div class="pattern-desc">ticker â†’ 3AIåˆè­°ã§ã€Œè²·ã„/å£²ã‚Šã€åˆ¤å®š</div>
                </div>
              </label>

              <label class="pattern-option">
                <input type="radio" name="pattern" value="document">
                <div class="pattern-label">
                  <div class="pattern-name">C. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè§£æ</div>
                  <div class="pattern-desc">ticker + PDF â†’ æ±ºç®—ã¨æ ªä¾¡ã®æ•´åˆæ€§åˆ¤å®š</div>
                </div>
              </label>
            </div>

            <div class="upload-container" id="uploadContainer">
              <label class="upload-label">ğŸ“„ æ±ºç®—å ±å‘Šæ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
              <input type="file" id="stockDocument" class="upload-input" accept=".pdf,.txt">
            </div>
          </div>

          <button id="analyzeBtn" class="btn-submit">åˆ†æé–‹å§‹</button>
        </div>
        <div id="stockResultArea"></div>
      </div>

      <div id="history" class="container">
        <div class="result-container">
          <div class="result-header">è³ªå•å±¥æ­´</div>
          <ul id="historyList" style="list-style: none;">
            <li style="color: #999; padding: 2rem 0; text-align: center;">ã¾ã è³ªå•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</li>
          </ul>
        </div>
      </div>

      <div id="settings" class="container">
        <div class="result-container">
          <div class="result-header">è¨­å®š</div>
          <div style="font-size: 0.9rem; color: #666;">
            <div style="margin-bottom: 1rem;">Version: 4.0</div>
            <div style="margin-bottom: 1rem;">Endpoint: Cloud Run</div>
            <div>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æ¥ç¶šä¸­...</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const VALID_USERS = { 'admin': 'magi2024' };
    let currentUser = null;

    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('userId').value;
      const pw = document.getElementById('userPassword').value;
      if (VALID_USERS[id] === pw) {
        currentUser = id;
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainApp').classList.add('logged-in');
      }
    });

    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');

    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    });

    overlay.addEventListener('click', () => {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
    });

    document.querySelectorAll('.sidebar-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        const tab = e.target.dataset.tab;
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
      });
    });

    // ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('input[name="pattern"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const uploadContainer = document.getElementById('uploadContainer');
        if (e.target.value === 'document') {
          uploadContainer.classList.add('active');
        } else {
          uploadContainer.classList.remove('active');
        }
      });
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('mainApp').classList.remove('logged-in');
    });

    document.getElementById('submitBtn').addEventListener('click', async () => {
      const prompt = document.getElementById('prompt').value.trim();
      if (!prompt) return alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      
      const mode = document.getElementById('mode').value;
      const temp = document.getElementById('temperature').value;
      
      document.getElementById('resultArea').innerHTML = '<div class="status-message status-loading">3ã¤ã®AIãŒæ€è€ƒä¸­...</div>';

      try {
        const res = await fetch('/api/consensus', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, meta: { mode, temperature: parseFloat(temp) } })
        });
        const data = await res.json();
        document.getElementById('resultArea').innerHTML = `
          <div class="result-container">
            <div class="result-header">å›ç­”</div>
            <div class="final-answer">
              <div class="final-label">æœ€çµ‚å›ç­”</div>
              <div class="final-text">${data.final}</div>
            </div>
            <div class="metrics">
              <div class="metric-item"><div class="metric-value">${data.mode}</div><div class="metric-label">ãƒ¢ãƒ¼ãƒ‰</div></div>
              <div class="metric-item"><div class="metric-value">${data.metrics.response_time_ms}ms</div><div class="metric-label">å¿œç­”æ™‚é–“</div></div>
              <div class="metric-item"><div class="metric-value">${data.metrics.valid_responses}/3</div><div class="metric-label">æˆåŠŸæ•°</div></div>
            </div>
          </div>
        `;
      } catch (e) {
        document.getElementById('resultArea').innerHTML = `<div class="status-message status-error">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
      }
    });

    document.getElementById('searchStockBtn').addEventListener('click', async () => {
      const ticker = document.getElementById('ticker').value.toUpperCase();
      if (!ticker) return alert('ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

      try {
        const res = await fetch('/api/stock/fetch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ symbol: ticker })
        });
        const data = await res.json();
        const fd = data.financialData;
        document.getElementById('stockResultArea').innerHTML = `
          <div class="result-container">
            <div class="result-header">${ticker} - ä¼æ¥­æƒ…å ±</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <div style="color: #666; font-size: 0.9rem;">ä¼æ¥­å</div>
                <div style="font-weight: 600; margin-bottom: 1rem;">${fd.companyName}</div>
                <div style="color: #666; font-size: 0.9rem;">ç¾åœ¨æ ªä¾¡</div>
                <div style="font-weight: 600; font-size: 1.2rem;">$${fd.currentPrice}</div>
              </div>
              <div>
                <div style="color: #666; font-size: 0.9rem;">æ™‚ä¾¡ç·é¡</div>
                <div style="font-weight: 600; margin-bottom: 1rem;">$${(fd.marketCap / 1e9).toFixed(2)}B</div>
                <div style="color: #666; font-size: 0.9rem;">PER</div>
                <div style="font-weight: 600;">${fd.per}</div>
              </div>
            </div>
          </div>
        `;
      } catch (e) {
        document.getElementById('stockResultArea').innerHTML = `<div class="status-message status-error">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
      }
    });

    document.getElementById('analyzeBtn').addEventListener('click', async () => {
      const ticker = document.getElementById('ticker').value.toUpperCase();
      const pattern = document.querySelector('input[name="pattern"]:checked').value;

      if (!ticker) return alert('ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

      if (pattern === 'simple') {
        document.getElementById('searchStockBtn').click();
        return;
      }

      let prompt = pattern === 'analysis' 
        ? `${ticker}ã¯è²·ã„ã‹å£²ã‚Šã‹ã€3ã¤ã®è¦–ç‚¹ã‹ã‚‰åˆ†æã—ã¦ãã ã•ã„`
        : `${ticker}ã®æ±ºç®—ã¨ç¾åœ¨æ ªä¾¡ã¯å¦¥å½“ã‹ã€3ã¤ã®è¦–ç‚¹ã‹ã‚‰åˆ†æã—ã¦ãã ã•ã„`;

      document.getElementById('stockResultArea').innerHTML = '<div class="status-message status-loading">3ã¤ã®AIãŒåˆ†æä¸­...</div>';

      try {
        const res = await fetch('/api/consensus', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, meta: { mode: 'integration', temperature: 0.3 } })
        });
        const data = await res.json();
        document.getElementById('stockResultArea').innerHTML = `
          <div class="result-container">
            <div class="result-header">åˆ†æçµæœï¼š${ticker}</div>
            <div class="final-answer">
              <div class="final-label">3AIçµ±åˆåˆ¤æ–­</div>
              <div class="final-text">${data.final}</div>
            </div>
            <div class="metrics">
              <div class="metric-item"><div class="metric-value">${data.mode}</div><div class="metric-label">ãƒ¢ãƒ¼ãƒ‰</div></div>
              <div class="metric-item"><div class="metric-value">${data.metrics.response_time_ms}ms</div><div class="metric-label">å¿œç­”æ™‚é–“</div></div>
              <div class="metric-item"><div class="metric-value">${data.metrics.valid_responses}/3</div><div class="metric-label">æˆåŠŸæ•°</div></div>
            </div>
          </div>
        `;
      } catch (e) {
        document.getElementById('stockResultArea').innerHTML = `<div class="status-message status-error">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
      }
    });
  </script>
</body>
</html>
